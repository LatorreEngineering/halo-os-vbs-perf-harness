name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-22.04
    env:
      WORKSPACE: ${{ github.workspace }}
      GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}

    steps:
      # -------------------------------
      # Checkout repository
      # -------------------------------
      - uses: actions/checkout@v3

      # -------------------------------
      # Make CI scripts executable
      # -------------------------------
      - name: Make CI scripts executable
        run: chmod +x ./ci/*.sh

      # -------------------------------
      # Setup environment
      # -------------------------------
      - name: Setup environment
        run: ./ci/setup_env.sh

      # -------------------------------
      # Install 'repo' tool
      # -------------------------------
      - name: Install repo tool
        run: |
          mkdir -p ~/bin
          curl -sSL https://storage.googleapis.com/git-repo-downloads/repo -o ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH
          export PATH="$HOME/bin:$PATH"
          repo --version

      # -------------------------------
      # Initialize & Sync Halo.OS manifests
      # -------------------------------
      - name: Initialize & Sync Halo.OS
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: |
          set -e
          HALO_WS="$WORKSPACE/halo_os_workspace"
          mkdir -p "$HALO_WS"
          cd "$HALO_WS"

          # Use GITEE_TOKEN if private repos
          if [ -n "${GITEE_TOKEN:-}" ]; then
            git config --global url."https://${GITEE_TOKEN}:x-oauth-basic@gitee.com/".insteadOf "https://gitee.com/"
          fi

          # Init with pinned manifest
          repo init -u https://github.com/LatorreEngineering/halo-os-vbs-perf-harness \
                    -m manifests/pinned_manifest.xml

          # Sync repos with retries
          MAX_RETRIES=3
          RETRY_DELAY=10
          count=0
          until [ $count -ge $MAX_RETRIES ]; do
            repo sync -j$(nproc) && break
            count=$((count+1))
            echo "repo sync failed; retrying in ${RETRY_DELAY}s (attempt $count/$MAX_RETRIES)"
            sleep $RETRY_DELAY
          done

          if [ $count -ge $MAX_RETRIES ]; then
            echo "❌ Repo sync failed after $MAX_RETRIES attempts"
            exit 1
          fi

      # -------------------------------
      # Cache Python packages
      # -------------------------------
      - name: Cache Python packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: python-pip-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            python-pip-${{ runner.os }}-

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install Python dependencies
        run: pip install --upgrade pip && pip install -r requirements.txt

      # -------------------------------
      # Cache Halo build artifacts
      # -------------------------------
      - name: Cache Halo build
        id: halo-cache
        uses: actions/cache@v3
        with:
          path: build-halo
          key: halo-build-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            halo-build-${{ runner.os }}-

      # -------------------------------
      # Build Halo.OS demo
      # -------------------------------
      - name: Build Halo.OS demo
        if: steps.halo-cache.outputs.cache-hit != 'true'
        run: ./ci/build_halo.sh

      # -------------------------------
      # Run sample experiment
      # -------------------------------
      - name: Run sample experiment
        run: ./ci/run_experiment.sh results_test 30

      # -------------------------------
      # Cache VBS analysis results
      # -------------------------------
      - name: Cache VBS analysis results
        id: analysis-cache
        uses: actions/cache@v3
        with:
          path: results_test
          key: analysis-results-${{ runner.os }}-${{ hashFiles('results_test/**/*') }}
          restore-keys: |
            analysis-results-${{ runner.os }}-

      # -------------------------------
      # Run VBS analysis
      # -------------------------------
      - name: Run VBS analysis
        if: steps.analysis-cache.outputs.cache-hit != 'true'
        run: python3 ci/analyze_vbs.py \
              --trace results_test \
              --output results_test \
              --start_event halo_camera_ingest \
              --end_event halo_brake_actuate \
              --bins 30

      # -------------------------------
      # Python linting
      # -------------------------------
      - name: Run Python linter
        run: flake8 ci/analyze_vbs.py

      - name: Check Python formatting
        run: black --check ci/analyze_vbs.py

      # -------------------------------
      # Shell script linting
      # -------------------------------
      - name: ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          files: 'ci/*.sh'

      # -------------------------------
      # Validate analysis results
      # -------------------------------
      - name: Validate results
        run: |
          python3 - <<'EOF'
          import json
          from pathlib import Path

          run_dirs = sorted(Path("results_test").glob("run_*"))
          if not run_dirs:
              raise FileNotFoundError("No analysis run directories found!")

          result_file = run_dirs[-1] / "latency_results.json"
          if not result_file.exists():
              raise FileNotFoundError("Latency results JSON not found!")

          with open(result_file) as f:
              results = json.load(f)

          assert results["num_samples"] > 0, "No samples processed!"
          assert results["mean_ms"] > 0, "Mean latency is zero!"
          print("✅ Analysis results validated successfully!")
          EOF
