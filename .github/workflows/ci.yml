name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-22.04
    env:
      WORKSPACE: ${{ github.workspace }}
      GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}   # <-- Add your Gitee token as a GitHub secret

    steps:
      # -------------------------------
      # Checkout repository
      # -------------------------------
      - uses: actions/checkout@v3

      # -------------------------------
      # Make CI scripts executable
      # -------------------------------
      - name: Make CI scripts executable
        run: chmod +x ./ci/*.sh

      # -------------------------------
      # Setup environment
      # -------------------------------
      - name: Setup environment
        run: ./ci/setup_env.sh

      # -------------------------------
      # Install repo tool
      # -------------------------------
      - name: Install repo tool
        run: |
          mkdir -p ~/bin
          curl -sSL https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          export PATH=~/bin:$PATH
          repo --version

      # -------------------------------
      # Build Halo.OS demo
      # -------------------------------
      - name: Build Halo.OS demo
        run: ./ci/build_halo.sh

      # -------------------------------
      # Run sample experiment
      # -------------------------------
      - name: Run sample experiment
        run: ./ci/run_experiment.sh ci_test 30

      # -------------------------------
      # Python environment & linting
      # -------------------------------
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install Python dependencies
        run: pip install pandas matplotlib numpy flake8 black

      - name: Run Python linter
        run: flake8 ci/analyze_vbs.py

      - name: Check Python formatting
        run: black --check ci/analyze_vbs.py

      # -------------------------------
      # Shell script linting
      # -------------------------------
      - name: ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          files: 'ci/*.sh'

      # -------------------------------
      # Run VBS analysis
      # -------------------------------
      - name: Run VBS analysis
        run: |
          mkdir -p results_test
          python3 ci/analyze_vbs.py \
            --trace results/ci_test \
            --output results_test \
            --start_event halo_camera_ingest \
            --end_event halo_brake_actuate \
            --bins 30

      # -------------------------------
      # Validate analysis results
      # -------------------------------
      - name: Validate results
        run: |
          python3 - <<'EOF'
          import json
          from pathlib import Path

          run_dirs = sorted(Path("results_test").glob("run_*"))
          if not run_dirs:
              raise FileNotFoundError("No analysis run directories found!")

          result_file = run_dirs[-1] / "latency_results.json"
          if not result_file.exists():
              raise FileNotFoundError("Latency results JSON not found!")

          with open(result_file) as f:
              results = json.load(f)

          assert results["num_samples"] > 0, "No samples processed!"
          assert results["mean_latency_ms"] > 0, "Mean latency is zero!"
          print("âœ… Analysis results validated successfully!")
          EOF
