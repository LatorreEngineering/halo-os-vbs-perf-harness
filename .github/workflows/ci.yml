name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-22.04
    env:
      WORKSPACE: ${{ github.workspace }}
      GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}

    steps:
      # -------------------------------
      # Checkout repository
      # -------------------------------
      - uses: actions/checkout@v3

      # -------------------------------
      # Make CI scripts executable
      # -------------------------------
      - name: Make CI scripts executable
        run: chmod +x ./ci/*.sh

      # -------------------------------
      # Setup environment
      # -------------------------------
      - name: Setup environment
        run: ./ci/setup_env.sh

      # -------------------------------
      # Install 'repo' tool
      # -------------------------------
      - name: Install repo tool
        run: |
          mkdir -p ~/bin
          curl -sSL https://storage.googleapis.com/git-repo-downloads/repo -o ~/bin/repo
          chmod a+x ~/bin/repo
          echo "PATH=$HOME/bin:$PATH" >> $GITHUB_ENV
          repo --version

      # -------------------------------
      # Initialize & Sync Repo with retries
      # -------------------------------
      - name: Initialize & Sync Repo
        run: |
          set -e
          MAX_RETRIES=3
          RETRY_DELAY=10
          count=0
          while [ $count -lt $MAX_RETRIES ]; do
            echo "Attempt $((count+1)) to init & sync repo"
            if repo init -u https://github.com/LatorreEngineering/halo-os-vbs-perf-harness; then
              if repo sync -j$(nproc); then
                echo "Repo synced successfully"
                break
              fi
            fi
            count=$((count+1))
            echo "Repo sync failed, retrying in $RETRY_DELAY seconds..."
            sleep $RETRY_DELAY
          done
          if [ $count -eq $MAX_RETRIES ]; then
            echo "❌ Repo init/sync failed after $MAX_RETRIES attempts"
            exit 1
          fi

      # -------------------------------
      # Cache Python dependencies
      # -------------------------------
      - name: Cache Python packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: python-pip-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            python-pip-${{ runner.os }}-

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install Python dependencies
        run: pip install --upgrade pip && pip install pandas matplotlib numpy flake8 black

      # -------------------------------
      # Cache Halo build artifacts
      # -------------------------------
      - name: Cache Halo build
        id: halo-cache
        uses: actions/cache@v3
        with:
          path: build-halo
          key: halo-build-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            halo-build-${{ runner.os }}-

      # -------------------------------
      # Build Halo.OS demo (conditional)
      # -------------------------------
      - name: Build Halo.OS demo
        if: steps.halo-cache.outputs.cache-hit != 'true'
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: ./ci/build_halo.sh

      # -------------------------------
      # Run sample experiment
      # -------------------------------
      - name: Run sample experiment
        run: ./ci/run_experiment.sh ci_test 30

      # -------------------------------
      # Cache VBS analysis results
      # -------------------------------
      - name: Cache VBS analysis results
        id: analysis-cache
        uses: actions/cache@v3
        with:
          path: results_test
          key: analysis-results-${{ runner.os }}-${{ hashFiles('results/ci_test/**/*') }}
          restore-keys: |
            analysis-results-${{ runner.os }}-

      # -------------------------------
      # Run VBS analysis (conditional)
      # -------------------------------
      - name: Run VBS analysis
        if: steps.analysis-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p results_test
          python3 ci/analyze_vbs.py \
            --trace results/ci_test \
            --output results_test \
            --start_event halo_camera_ingest \
            --end_event halo_brake_actuate \
            --bins 30

      # -------------------------------
      # Python linting
      # -------------------------------
      - name: Run Python linter
        run: flake8 ci/analyze_vbs.py

      - name: Check Python formatting
        run: black --check ci/analyze_vbs.py

      # -------------------------------
      # Shell script linting
      # -------------------------------
      - name: ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          files: 'ci/*.sh'

      # -------------------------------
      # Validate analysis results
      # -------------------------------
      - name: Validate results
        run: |
          python3 - <<'EOF'
          import json
          from pathlib import Path

          run_dirs = sorted(Path("results_test").glob("run_*"))
          if not run_dirs:
              raise FileNotFoundError("No analysis run directories found!")

          result_file = run_dirs[-1] / "latency_results.json"
          if not result_file.exists():
              raise FileNotFoundError("Latency results JSON not found!")

          with open(result_file) as f:
              results = json.load(f)

          assert results["num_samples"] > 0, "No samples processed!"
          assert results["mean_latency_ms"] > 0, "Mean latency is zero!"
          print("✅ Analysis results validated successfully!")
          EOF
