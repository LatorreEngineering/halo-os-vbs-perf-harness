name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v3

      # -------------------------------
      # Existing environment setup
      # -------------------------------
      - name: Make setup_env.sh executable
        run: chmod +x ./ci/setup_env.sh

      - name: Setup environment
        run: ./ci/setup_env.sh

      - name: Build Halo.OS demo
        run: ./ci/build_halo.sh

      # -------------------------------
      # Run experiment
      # -------------------------------
      - name: Run sample experiment
        run: ./ci/run_experiment.sh ci_test 30

      # -------------------------------
      # Python linting
      # -------------------------------
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install Python dependencies
        run: pip install pandas matplotlib numpy flake8 black

      - name: Run Python linter
        run: flake8 ci/analyze.py

      - name: Check formatting
        run: black --check ci/analyze.py

      # -------------------------------
      # Shell script linting
      # -------------------------------
      - name: Shellcheck
        uses: ludeeus/action-shellcheck@v1
        with:
          files: 'ci/*.sh'

      # -------------------------------
      # Run modular analysis
      # -------------------------------
      - name: Run VBS analysis
        run: |
          mkdir -p results_test
          ./run_vbs_analysis.sh \
            --trace results/ci_test \
            --output results_test \
            --start_event halo_camera_ingest \
            --end_event halo_brake_actuate

      # -------------------------------
      # Validate analysis results
      # -------------------------------
      - name: Validate results
        run: |
          python3 - <<'EOF'
          import json
          from pathlib import Path

          run_dirs = sorted(Path("results_test").glob("run_*"))
          if not run_dirs:
              raise FileNotFoundError("No analysis run directories found!")

          result_file = run_dirs[-1] / "latency_results.json"
          if not result_file.exists():
              raise FileNotFoundError("Latency results JSON not found!")

          with open(result_file) as f:
              results = json.load(f)

          assert results["num_samples"] > 0, "No samples processed!"
          assert results["mean_latency_ms"] > 0, "Mean latency is zero!"
          print("âœ… Analysis results validated successfully!")
          EOF
